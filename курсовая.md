#### 1. Создайте виртуальную машину Linux.

#### 2. Установите ufw и разрешите к этой машине сессии на порты 22 и 443, при этом трафик на интерфейсе localhost (lo) должен ходить свободно на все порты.

```
apt install ufw

WARNING: apt does not have a stable CLI interface. Use with caution in scripts.

Reading package lists...
Building dependency tree...
Reading state information...
ufw is already the newest version (0.36-6).
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
ufw enable
Command may disrupt existing ssh connections. Proceed with operation (y|n)? y
Firewall is active and enabled on system startup
ufw status
Status: active
ufw allow ssh
Rule added
Rule added (v6)
ufw allow 443
Rule added
Rule added (v6)
```

#### 3. Установите hashicorp vault ([инструкция по ссылке](https://learn.hashicorp.com/tutorials/vault/getting-started-install?in=vault/getting-started#install-vault)).

```
curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
Warning: apt-key output should not be parsed (stdout is not a terminal)
OK
sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
Hit:1 http://archive.ubuntu.com/ubuntu focal InRelease
Get:2 http://security.ubuntu.com/ubuntu focal-security InRelease [114 kB]
Get:3 http://archive.ubuntu.com/ubuntu focal-updates InRelease [114 kB]
Get:4 https://apt.releases.hashicorp.com focal InRelease [9,495 B]
Get:5 https://apt.releases.hashicorp.com focal/main amd64 Packages [42.5 kB]
Get:6 http://archive.ubuntu.com/ubuntu focal-backports InRelease [108 kB]
Get:7 http://security.ubuntu.com/ubuntu focal-security/main i386 Packages [362 kB]
Get:8 http://archive.ubuntu.com/ubuntu focal-updates/main i386 Packages [591 kB]
Get:9 http://archive.ubuntu.com/ubuntu focal-updates/main amd64 Packages [1,509 kB]
Get:10 http://security.ubuntu.com/ubuntu focal-security/main amd64 Packages [1,177 kB]
Get:11 http://security.ubuntu.com/ubuntu focal-security/main Translation-en [210 kB]
Get:12 http://archive.ubuntu.com/ubuntu focal-updates/main Translation-en [296 kB]
Get:13 http://archive.ubuntu.com/ubuntu focal-updates/restricted i386 Packages [21.8 kB]
Get:14 http://archive.ubuntu.com/ubuntu focal-updates/restricted amd64 Packages [736 kB]
Get:15 http://security.ubuntu.com/ubuntu focal-security/restricted i386 Packages [20.5 kB]
Get:16 http://security.ubuntu.com/ubuntu focal-security/restricted amd64 Packages [686 kB]
Get:17 http://archive.ubuntu.com/ubuntu focal-updates/restricted Translation-en [105 kB]
Get:18 http://archive.ubuntu.com/ubuntu focal-updates/universe amd64 Packages [893 kB]
Get:19 http://security.ubuntu.com/ubuntu focal-security/restricted Translation-en [97.9 kB]
Get:20 http://security.ubuntu.com/ubuntu focal-security/universe amd64 Packages [675 kB]
Get:21 http://archive.ubuntu.com/ubuntu focal-updates/universe i386 Packages [663 kB]
Get:22 http://archive.ubuntu.com/ubuntu focal-updates/universe Translation-en [196 kB]
Get:23 http://archive.ubuntu.com/ubuntu focal-updates/multiverse amd64 Packages [24.8 kB]
Get:24 http://archive.ubuntu.com/ubuntu focal-updates/multiverse i386 Packages [8,432 B]
Get:25 http://archive.ubuntu.com/ubuntu focal-updates/multiverse Translation-en [6,928 B]
Get:26 http://archive.ubuntu.com/ubuntu focal-backports/main amd64 Packages [42.0 kB]
Get:27 http://archive.ubuntu.com/ubuntu focal-backports/main i386 Packages [34.5 kB]
Get:28 http://archive.ubuntu.com/ubuntu focal-backports/main Translation-en [10.0 kB]
Get:29 http://archive.ubuntu.com/ubuntu focal-backports/universe i386 Packages [11.1 kB]
Get:30 http://archive.ubuntu.com/ubuntu focal-backports/universe amd64 Packages [19.5 kB]
Get:31 http://security.ubuntu.com/ubuntu focal-security/universe i386 Packages [532 kB]
Get:32 http://archive.ubuntu.com/ubuntu focal-backports/universe Translation-en [13.4 kB]
Get:33 http://security.ubuntu.com/ubuntu focal-security/universe Translation-en [115 kB]
Get:34 http://security.ubuntu.com/ubuntu focal-security/multiverse amd64 Packages [21.8 kB]
Get:35 http://security.ubuntu.com/ubuntu focal-security/multiverse i386 Packages [7,176 B]
Get:36 http://security.ubuntu.com/ubuntu focal-security/multiverse Translation-en [4,948 B]
Fetched 9,478 kB in 40s (235 kB/s)
Reading package lists...
sudo apt-get update && sudo apt-get install vault
Hit:1 http://archive.ubuntu.com/ubuntu focal InRelease
Hit:2 http://security.ubuntu.com/ubuntu focal-security InRelease
Hit:3 http://archive.ubuntu.com/ubuntu focal-updates InRelease
Hit:4 http://archive.ubuntu.com/ubuntu focal-backports InRelease
Hit:5 https://apt.releases.hashicorp.com focal InRelease
Reading package lists...
Reading package lists...
Building dependency tree...
Reading state information...
The following NEW packages will be installed:
  vault
0 upgraded, 1 newly installed, 0 to remove and 109 not upgraded.
Need to get 69.4 MB of archives.
After this operation, 188 MB of additional disk space will be used.
Get:1 https://apt.releases.hashicorp.com focal/main amd64 vault amd64 1.9.2 [69.4 MB]
debconf: unable to initialize frontend: Dialog
debconf: (Dialog frontend will not work on a dumb terminal, an emacs shell buffer, or without a controlling terminal.)
debconf: falling back to frontend: Readline
debconf: unable to initialize frontend: Readline
debconf: (This frontend requires a controlling tty.)
debconf: falling back to frontend: Teletype
dpkg-preconfigure: unable to re-open stdin: 
Fetched 69.4 MB in 11min 45s (98.4 kB/s)
Selecting previously unselected package vault.
(Reading database ... 41552 files and directories currently installed.)
Preparing to unpack .../archives/vault_1.9.2_amd64.deb ...
Unpacking vault (1.9.2) ...
Setting up vault (1.9.2) ...
Generating Vault TLS key and self-signed certificate...
Generating a RSA private key
................................................++++
............................++++
writing new private key to 'tls.key'
-----
Vault TLS key and self-signed certificate have been generated in '/opt/vault/tls'.
```

Проверка установки 

```
vault
Usage: vault <command> [args]

Common commands:
    read        Read data and retrieves secrets
    write       Write data, configuration, and secrets
    delete      Delete secrets and configuration
    list        List data or secrets
    login       Authenticate locally
    agent       Start a Vault agent
    server      Start a Vault server
    status      Print seal and HA status
    unwrap      Unwrap a wrapped secret

Other commands:
    audit          Interact with audit devices
    auth           Interact with auth methods
    debug          Runs the debug command
    kv             Interact with Vault's Key-Value storage
    lease          Interact with leases
    monitor        Stream log messages from a Vault server
    namespace      Interact with namespaces
    operator       Perform operator-specific tasks
    path-help      Retrieve API help for paths
    plugin         Interact with Vault plugins and catalog
    policy         Interact with policies
    print          Prints runtime configurations
    secrets        Interact with secrets engines
    ssh            Initiate an SSH session
    token          Interact with tokens
```

#### 4. Cоздайте центр сертификации по инструкции ([ссылка](https://learn.hashicorp.com/tutorials/vault/pki-engine?in=vault/secrets-management)) и выпустите сертификат для использования его в настройке веб-сервера nginx (срок жизни сертификата - месяц).

```
export VAULT_ADDR=http://127.0.0.1:8200
export VAULT_TOKEN=root
vault secrets enable pki
Success! Enabled the pki secrets engine at: pki/
vault secrets tune -max-lease-ttl=87600h pki
Success! Tuned the secrets engine at: pki/
vault write -field=certificate pki/root/generate/internal \
common_name="example.com" \
ttl=87600h > CA_cert.crt
vault write pki/config/urls \
issuing_certificates="$VAULT_ADDR/v1/pki/ca" \
rl_distribution_points="$VAULT_ADDR/v1/pki/crl"
Success! Data written to: pki/config/urls
vault secrets enable -path=pki_int pki
Success! Enabled the pki secrets engine at: pki_int/
vault secrets tune -max-lease-ttl=43800h pki_int
Success! Tuned the secrets engine at: pki_int/
vault write -format=json pki_int/intermediate/generate/internal \
common_name="example.com Intermediate Authority" \
| jq -r '.data.csr' > pki_intermediate.csr
vault write -format=json pki/root/sign-intermediate csr=@pki_intermediate.csr \
format=pem_bundle ttl="43800h" \
| jq -r '.data.certificate' > intermediate.cert.pem
vault write pki_int/intermediate/set-signed certificate=@intermediate.cert.pem
Success! Data written to: pki_int/intermediate/set-signed
vault write pki_int/roles/example-dot-com \
allowed_domains="example.com" \
allow_subdomains=true \
max_ttl="720h"
Success! Data written to: pki_int/roles/example-dot-com
json_cert=`vault write -format=json pki_int/issue/example-dot-com common_name="test.example.com" ttl="720h"`
echo $json_cert|jq -r '.data.certificate'>test.example.com.crt
echo $json_cert|jq -r '.data.private_key'>test.example.com.key
```

#### 5. Установите корневой сертификат созданного центра сертификации в доверенные в хостовой системе.

Сохранил на хост-машине и добавил в Доверенные центры сертификации. 

```
-----BEGIN CERTIFICATE-----
MIIDNTCCAh2gAwIBAgIUEMEGEMgoDbBLVpIyxNzPLQtU+LgwDQYJKoZIhvcNAQEL
BQAwFjEUMBIGA1UEAxMLZXhhbXBsZS5jb20wHhcNMjIwMTIwMDcxODU4WhcNMzIw
MTE4MDcxOTI4WjAWMRQwEgYDVQQDEwtleGFtcGxlLmNvbTCCASIwDQYJKoZIhvcN
AQEBBQADggEPADCCAQoCggEBAOCZgodftPtheFD/OTnjZDg86JMeztEWsz9C2oDI
Lpu1GkYy7ySWR+alXYbHT9puqcdxB4UAQTKz2sTc3SlQFQBhU5mMwYaPV/eZua2L
aLhsoVXJrhv21cHjcwoIsmwFlnBtUjyNqaY/Ro0mtWRZi0//tDQbTAo2JVep/6s1
cE9Qdaf+APIIJ4Fq8EY3IOqkHaN4VX2n63JPMMnF+UyzTxGjy5alT92KR2BY98Jv
7ARiIfQLeMIlOCLYs7KLggFGg2I3T4q3jIlsZ7mo7zhgROcIMYnf4+1d+N2/3a1E
Gk5WEiF6HiBVUQO/9e9GIskpYQq7hXrvcNiziBwcwk2EqOsCAwEAAaN7MHkwDgYD
VR0PAQH/BAQDAgEGMA8GA1UdEwEB/wQFMAMBAf8wHQYDVR0OBBYEFOg9qeqicTFs
BHS8cYmFEWNwt7luMB8GA1UdIwQYMBaAFOg9qeqicTFsBHS8cYmFEWNwt7luMBYG
A1UdEQQPMA2CC2V4YW1wbGUuY29tMA0GCSqGSIb3DQEBCwUAA4IBAQBJCD5keU0r
+X7S3o/oiW1UUgDVUTTzdthfG3WtpBDWvudoBuIpAuXE+Y5Mdf56zvPanjCcl0Td
leQuKhVY3itVlvt9IM4CrrykUa+lu4MFHeOc5GCQyQIOtI5KPRa8SVE6FOCq1Awr
j+W0kybwZXlgT7BDLh5Nv+/HFCVmA5c5Ku7P7LwKHj5g0RXLq5MLlqOluGokSJYO
yDueRPuMg3I58wNUZxdAmwzOqSeWAJWSxaJQFQl05X4BcVjVbtfKlN8qkYLL6Zvp
VyESwucboqtEv69nWgUDDPHgUMrLYfJBt+pHBTDpLOFdmNUpecf1H+QPYFCLKlEj
ZRLjJEYM18rd
-----END CERTIFICATE-----
```

#### 6. Установите nginx.

Установлен.

```
systemctl status nginx
         тЧП nginx.service - A high performance web server and a reverse proxy server
              Loaded: loaded (/lib/systemd/system/nginx.service; enabled; vendor preset: enabled)
              Active: active (running) since Thu 2022-01-20 07:39:24 UTC; 17s ago
                Docs: man:nginx(8)
             Process: 16537 ExecReload=/usr/sbin/nginx -g daemon on; master_process on; -s reload (code=exited, status=0/SUCCESS)
            Main PID: 16343 (nginx)
               Tasks: 3 (limit: 1071)
              Memory: 4.7M
              CGroup: /system.slice/nginx.service
                      тФЬтФА16343 nginx: master process /usr/sbin/nginx -g daemon on; master_process on;
                      тФЬтФА16541 nginx: worker process
                      тФФтФА16542 nginx: worker process

         Jan 20 07:39:24 vagrant systemd[1]: Starting A high performance web server and a reverse proxy server...
         Jan 20 07:39:24 vagrant systemd[1]: Started A high performance web server and a reverse proxy server.
         Jan 20 07:39:28 vagrant systemd[1]: Reloading A high performance web server and a reverse proxy server.
         Jan 20 07:39:28 vagrant systemd[1]: Reloaded A high performance web server and a reverse proxy server.


```

#### 7. По инструкции ([ссылка](https://nginx.org/en/docs/http/configuring_https_servers.html)) настройте nginx на https, используя ранее подготовленный сертификат:

Создал папку и скопировал в нее сертификат и закрытый ключ

```
mkdir /etc/nginx/ssl
cp test.example.com.crt /etc/nginx/ssl
cp test.example.com.key /etc/nginx/ssl
```

Изменил файл конфигурации 

```
listen 443 ssl default_server;
server_name         test.example.com;
ssl_certificate     /etc/nginx/ssl/test.example.com.crt;
ssl_certificate_key /etc/nginx/ssl/test.example.com.key;
```
https://photos.app.goo.gl/TFR64f7N57hsReqn8


Перезапускаем nginx

```
systemctl restart nginx
```

#### 8. Откройте в браузере на хосте https адрес страницы, которую обслуживает сервер nginx.

https://photos.app.goo.gl/bhinnYaF3xdyzTti8

#### 9. Создайте скрипт, который будет генерировать новый сертификат в vault:

```
vi new_cert.sh
-------------------
#!/usr/bin/env bash
json_cert=`vault write -format=json pki_int/issue/example-dot-com common_name="test.example.com" ttl="720h"`
echo $json_cert|jq -r '.data.certificate'>test.example.com.crt
echo $json_cert|jq -r '.data.private_key'>test.example.com.key
cp test.example.com.crt /etc/nginx/ssl
cp test.example.com.key /etc/nginx/ssl
-------------------
$ sudo chmod 755 new_cert.sh
$ ./new_cert.sh
```

Старый сертификат

https://photos.app.goo.gl/u6TLXjvS9JQSmYLJ7

Новый сертификат

https://photos.app.goo.gl/rViwS9j2wn7Tk1c9A

#### 10. Поместите скрипт в crontab, чтобы сертификат обновлялся какого-то числа каждого месяца в удобное для вас время.

```
crontab -e
0 12 20 * * /root/new_cert.sh
```



